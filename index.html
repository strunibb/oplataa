<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg1:#6a11cb; --bg2:#2575fc;
      --glass: rgba(255,255,255,.12);
      --line: rgba(255,255,255,.22);
      --white:#fff; --text:#eef2ff;
      --a1:#9b4dff; --a2:#6a11cb; --a3:#2575fc;
      --btn: linear-gradient(135deg, var(--a1), var(--a2));
      --btnH: linear-gradient(135deg, #b16eff, #7d2fff);
      --panelR: 16px;
      --trans: .22s ease;
      --shadow: 0 10px 24px rgba(0,0,0,.28);
    }
    *{box-sizing:border-box}
    html,body{margin:0}
    body{
      font-family: Arial, Helvetica, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--white);
      min-height: 100vh;
      padding: 16px;
      text-align: center;
    }
    h1{margin:6px 0 2px;font-size:26px;font-weight:900;letter-spacing:.3px;text-shadow:0 4px 14px rgba(0,0,0,.25)}
    .sub{opacity:.9;font-size:13px;margin-bottom:8px}

    /* Stepper */
    .stepper{ display:flex;justify-content:center;gap:10px;margin:8px auto 6px;user-select:none }
    .dot{ width:30px;height:30px;border-radius:50%; background:#ffffff1e;border:1px solid var(--line); display:grid;place-items:center;font-weight:800 }
    .dot.active{background:linear-gradient(135deg,#ffffff40,#ffffff24);border-color:#ffffff66}
    .dot.done{background:linear-gradient(135deg,#59ffa6,#29d17c);color:#173a30;border:none}

    /* Panels */
    .panel{max-width:960px;margin:12px auto 0;background:var(--glass);border:1px solid var(--line);border-radius:var(--panelR);box-shadow:var(--shadow);padding:14px}

    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap:12px; margin-top:8px }

    .catbtn, .optbtn, .mainbtn, .backbtn, .namebtn{
      display:block;width:100%; padding:12px;border-radius:14px;border:1px solid var(--line);
      background: linear-gradient(135deg, #ffffff22, #ffffff11); color:#fff;font-weight:800;cursor:pointer;
      box-shadow: var(--shadow); transition: transform var(--trans), background var(--trans), opacity var(--trans)
    }
    .catbtn:hover, .optbtn:hover, .backbtn:hover, .namebtn:hover{ transform: translateY(-2px); background: linear-gradient(135deg, #ffffff33, #ffffff18) }

    .card{ text-align:left;padding:12px;border-radius:14px;border:1px solid var(--line); background: linear-gradient(135deg, #ffffff12, #ffffff0a); box-shadow:0 6px 16px rgba(0,0,0,.22); transition: transform var(--trans), box-shadow var(--trans) }
    .card:hover{ transform: translateY(-2px); box-shadow:0 12px 28px rgba(0,0,0,.28) }
    .card h3{margin:0 0 8px;font-size:18px;border-bottom:1px solid var(--line);padding-bottom:6px}
    .card p{margin:6px 0;color:var(--text);font-size:14px}

    .row{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .optbtn{flex:1 1 130px}

    .mainbtn{ background: var(--btn); border:none;margin-top:12px;font-size:15px }
    .mainbtn:hover{ background: var(--btnH); transform: translateY(-1px) }
    .mainbtn:disabled{ opacity:.6;transform:none;cursor:not-allowed;filter:grayscale(0.2) }

    .backwrap{display:flex;justify-content:center;margin-top:12px}
    .backbtn{width:auto;padding:10px 16px}

    /* file + name */
    .filebox{margin-top:10px;display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
    .file-input{display:none}
    .file-label{ display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;cursor:pointer; background:linear-gradient(135deg, #ffffff22, #ffffff11); border:1px solid var(--line); font-weight:800 }
    .file-label:hover{transform:translateY(-1px);background:linear-gradient(135deg,#ffffff33,#ffffff18)}
    .file-info{font-size:12px;opacity:.95}
    .namebtn{width:auto;padding:10px 12px}

    /* hint */
    .hint{margin-top:8px;font-size:12px;opacity:.9}

    /* toast */
    .toast{ position:fixed;left:50%;bottom:16px;transform:translateX(-50%); background:rgba(0,0,0,.62);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15); backdrop-filter:blur(6px);box-shadow:0 8px 20px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .25s }
    .toast.show{opacity:1}

    @media (max-width:520px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <h1>üé∏ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</h1>
  <div class="sub">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –∞–±–æ–Ω–µ–º–µ–Ω—Ç ‚Üí –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ/—Ñ–∞–π–ª —á–µ–∫–∞ ‚Üí —É–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ</div>

  <div class="stepper" id="stepper">
    <div class="dot active" data-step="1">1</div>
    <div class="dot" data-step="2">2</div>
    <div class="dot" data-step="3">3</div>
  </div>

  <!-- –®–ê–ì 1: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
  <div id="step1" class="panel">
    <div class="grid" id="categories"></div>
  </div>

  <!-- –®–ê–ì 2: –ê–±–æ–Ω–µ–º–µ–Ω—Ç -->
  <div id="step2" class="panel" style="display:none">
    <h3 id="chosenCategory" style="margin:0 0 8px"></h3>
    <div id="plans" class="grid"></div>
    <div class="backwrap"><button class="backbtn" type="button" onclick="goStep(1)">‚Üê –ù–∞–∑–∞–¥</button></div>
  </div>

  <!-- –®–ê–ì 3: –ß–µ–∫ + –æ—Ç–ø—Ä–∞–≤–∫–∞ -->
  <div id="step3" class="panel" style="display:none">
    <h3 style="margin:0 0 8px">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
    <div id="summary" style="font-size:14px;opacity:.95"></div>

    <div class="filebox">
      <input type="file" id="receipt" class="file-input" accept="image/*,.pdf,.heic,.heif,.png,.jpg,.jpeg,.webp">
      <label class="file-label" for="receipt">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —á–µ–∫</label>
      <span id="fileInfo" class="file-info">—Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
      <!-- –ö–Ω–æ–ø–∫–∞ –≤–≤–æ–¥–∞ —Ñ–∞–º–∏–ª–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —á–µ–∫–∞ -->
      <button id="lastnameBtn" class="namebtn" type="button" style="display:none">üìù –§–∞–º–∏–ª–∏—è —É—á–µ–Ω–∏–∫–∞(—Ü—ã)</button>
    </div>

    <div id="hint" class="hint">–ß—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —á–µ–∫ –∏ —É–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é —É—á–µ–Ω–∏–∫–∞(—Ü—ã).</div>

    <button id="sendBtn" class="mainbtn" disabled>‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</button>
    <div class="backwrap"><button class="backbtn" type="button" onclick="goStep(2)">‚Üê –ù–∞–∑–∞–¥</button></div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ==== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ====
    const ADMIN_BOT_TOKEN = '7598736914:AAF1EK5D_g0gjflP7bKdtSgz8OyNz1q59PU';
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
    const ADMIN_IDS = ['725158536', '5056461242']; // + @Yuliya2821

    // ==== Telegram WebApp –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–µ–¥—ã ====
    const tg = window.Telegram?.WebApp;
    tg?.expand?.(); tg?.ready?.();

    // true, –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ –∫–∞–∫ WebApp –∏–∑ –±–æ—Ç–∞ –∏ –µ—Å—Ç—å initData/user
    const IS_TG_WEBAPP = !!(tg && (tg.initData || tg.initDataUnsafe?.user?.id));

    if (!IS_TG_WEBAPP) {
      document.body.innerHTML = `
        <div style="min-height:100vh;display:grid;place-items:center;padding:24px;color:#fff;background:linear-gradient(135deg,#6a11cb,#2575fc);text-align:center">
          <div style="max-width:560px">
            <h2 style="margin:0 0 8px">‚ùå –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ Telegram</h2>
            <p style="opacity:.9">
              –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –±–æ—Ç <b>@strunib_bot</b> –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É
              <b>¬´–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã¬ª</b>. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.
            </p>
          </div>
        </div>`;
      throw new Error('Not a Telegram WebApp context');
    }

    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ Telegram initData
    const me = tg?.initDataUnsafe?.user || null;

    // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∞–ª–µ—Ä—Ç (—Ñ–æ–ª–±—ç–∫ –Ω–∞ window.alert)
    function safeAlert(msg){
      if (tg?.showAlert) {
        try { tg.showAlert(msg); }
        catch(_){ alert(msg); }
      } else {
        alert(msg);
      }
    }

    // ==== –î–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è/–∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã) ====
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è desc —É –ø–ª–∞–Ω–æ–≤
    const DATA = {
      "üé∏ –ì–∏—Ç–∞—Ä–∞ / –≠–ª–µ–∫—Ç—Ä–æ–≥–∏—Ç–∞—Ä–∞": [
        { title: "üß© –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (1 –º–µ—Å—è—Ü)", options: ["4 —É—Ä–æ–∫–∞", "8 —É—Ä–æ–∫–æ–≤"] },
        { title: "üß© –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (2 –º–µ—Å—è—Ü–∞)", options: ["8 —É—Ä–æ–∫–æ–≤", "16 —É—Ä–æ–∫–æ–≤"] },
        { title: "üéØ –†–∞–∑–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ (40 –º–∏–Ω)", options: ["1 —É—Ä–æ–∫ (40 –º–∏–Ω)"] },
      ],
      "üéπ –§–æ—Ä—Ç–µ–ø–∏–∞–Ω–æ / –ü–∏–∞–Ω–∏–Ω–æ": [
        { title: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (1 –º–µ—Å—è—Ü)", options: ["4 –∑–∞–Ω—è—Ç–∏—è (40 –º–∏–Ω)", "8 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)"] },
        { title: "üë• –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (2 –º–µ—Å—è—Ü–∞)", options: ["8 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)", "16 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)"] }
      ],
      "üéµ –£–∫—É–ª–µ–ª–µ": [
        { title: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (1 –º–µ—Å—è—Ü)", options: ["4 –∑–∞–Ω—è—Ç–∏—è (40 –º–∏–Ω)", "8 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)"] },
        { title: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (2 –º–µ—Å—è—Ü–∞)", options: ["8 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)", "16 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)"] }
      ],

      // üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ (–ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ)
      "üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫": [
        {
          title: "üÜï –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (1 –º–µ—Å—è—Ü)",
          desc: "–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ–Ω–ª–∞–π–Ω-—É—Ä–æ–∫–∏ —Å —É–ø–æ—Ä–æ–º –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä, –ª–µ–∫—Å–∏–∫—É –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏ –∏ –∂–∏–≤–æ–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ.",
          options: [
            "4 —É—Ä–æ–∫–∞ (1 —á–∞—Å) ‚Äî 2 990 ‚ÇΩ (‚âà 748 ‚ÇΩ/—É—Ä–æ–∫)",
            "8 —É—Ä–æ–∫–æ–≤ (1 —á–∞—Å) ‚Äî 5 790 ‚ÇΩ (‚âà 724 ‚ÇΩ/—É—Ä–æ–∫)"
          ]
        },
        {
          title: "üìà –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (2 –º–µ—Å—è—Ü–∞)",
          desc: "–§–æ—Ä–º–∞—Ç –Ω–∞ –ø–æ–¥–æ–ª—å—à–µ: —Ç–µ –∂–µ —É—Å–ª–æ–≤–∏—è, –Ω–æ –≤—ã–≥–æ–¥–Ω–µ–µ –ø–æ —Ü–µ–Ω–µ –∑–∞ –∑–∞–Ω—è—Ç–∏–µ.",
          options: [
            "8 —É—Ä–æ–∫–æ–≤ (1 —á–∞—Å) ‚Äî 5 790 ‚ÇΩ (‚âà 724 ‚ÇΩ/—É—Ä–æ–∫)",
            "16 —É—Ä–æ–∫–æ–≤ (1 —á–∞—Å) ‚Äî 10 990 ‚ÇΩ (‚âà 687 ‚ÇΩ/—É—Ä–æ–∫)"
          ]
        },
        {
          title: "üéØ –†–∞–∑–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ (1 —á–∞—Å)",
          desc: "–¢–æ—á–µ—á–Ω—ã–π —Ä–∞–∑–±–æ—Ä –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏, –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è –∏–ª–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–π —Ç–µ–º—ã.",
          options: [
            "1 —É—Ä–æ–∫ ‚Äî 850 ‚ÇΩ"
          ]
        }
      ],

      // --- –†–∞–∑–¥–µ–ª –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞ ---
      "üë©‚Äçüè´ –ù–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ —Å –ù–∏–∫–∏—Ç–æ–π ": [
        {
          title: "–ù–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ (1 –º–µ—Å—è—Ü)",
          options: ["2 790 ‚ÇΩ –∑–∞ –º–µ—Å—è—Ü"]
        },
        {
          title: "–ù–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ (2 –º–µ—Å—è—Ü–∞)",
          options: ["4 990 ‚ÇΩ –∑–∞ 2 –º–µ—Å—è—Ü–∞"]
        }
      ],
      "üìò –ö—É—Ä—Å ¬´–ë–∞–∑–æ–≤—ã–π –º–∏–Ω–∏–º—É–º¬ª": [
        {
          title: "–û–ø—Ü–∏–∏ –æ–ø–ª–∞—Ç—ã",
          options: [
            "–í—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å—Ä–∞–∑—É (8 –º–æ–¥—É–ª–µ–π) ‚Äî 7 490 ‚ÇΩ",
            "2 –º–æ–¥—É–ª—è –≤ –º–µ—Å—è—Ü ‚Äî 1 872 ‚ÇΩ",
            "4 –º–æ–¥—É–ª—è –≤ –º–µ—Å—è—Ü ‚Äî 3 745 ‚ÇΩ"
          ]
        }
      ]
    };

    // ==== –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ ====
    const state = { category:null, plan:null, option:null, file:null, lastname:null };

    // ==== DOM ====
    const stepDots = [...document.querySelectorAll('.dot')];
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const categories = document.getElementById('categories');
    const plansWrap = document.getElementById('plans');
    const chosenCategory = document.getElementById('chosenCategory');
    const fileInput = document.getElementById('receipt');
    const fileInfo = document.getElementById('fileInfo');
    const lastnameBtn = document.getElementById('lastnameBtn');
    const sendBtn = document.getElementById('sendBtn');
    const toast = document.getElementById('toast');
    const hint = document.getElementById('hint');
    const summaryEl = document.getElementById('summary');

    // ==== UI helpers ====
    function setStep(n){
      stepDots.forEach((d,i)=>{
        d.classList.remove('active','done');
        if(i+1 < n) d.classList.add('done');
        else if(i+1 === n) d.classList.add('active');
      });
      step1.style.display = n===1?'block':'none';
      step2.style.display = n===2?'block':'none';
      step3.style.display = n===3?'block':'none';
    }
    function goStep(n){ setStep(n); }
    function toastMsg(msg,ms=2200){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),ms); }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –∫–Ω–æ–ø–∫–∏ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
    function updateSendState(){
      const hasFile = !!state.file;
      const hasLastname = !!(state.lastname && state.lastname.trim());
      const ready = hasFile && hasLastname;
      sendBtn.disabled = !ready;
      hint.textContent = ready ? '–í—Å–µ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ.' : '–ß—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —á–µ–∫ –∏ —É–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é —É—á–µ–Ω–∏–∫–∞(—Ü—ã).';
    }

    function updateSummary(){
      const whoBase = me?.username ? '@'+me.username : (me?.id ? 'id:'+me.id : '–≥–æ—Å—Ç—å');
      const fullName = [me?.first_name, me?.last_name].filter(Boolean).join(' ');
      summaryEl.innerHTML = `<div style="line-height:1.6">
          üë§ <b>${whoBase}${fullName ? ' ('+fullName+')' : ''}</b> ${state.lastname ? `(—Ñ–∞–º–∏–ª–∏—è: ${state.lastname})` : ''}<br>
          üìö <b>${state.category || '‚Äî'}</b><br>
          üßæ <b>${state.plan || '‚Äî'}</b><br>
          üíº <b>${state.option || '‚Äî'}</b>
        </div>`;
    }

    // ==== –†–µ–Ω–¥–µ—Ä —à–∞–≥–æ–≤ ====
    function renderStep1(){
      categories.innerHTML = '';
      Object.keys(DATA).forEach(cat=>{
        const btn = document.createElement('button');
        btn.className = 'catbtn';
        btn.textContent = cat;
        btn.onclick = ()=>{
          state.category = cat; state.plan=null; state.option=null;
          renderStep2(); setStep(2);
        };
        categories.appendChild(btn);
      });
    }

    function renderStep2(){
      chosenCategory.textContent = `–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${state.category}`;
      plansWrap.innerHTML = '';
      const plans = DATA[state.category];

      plans.forEach((p)=>{
        const card = document.createElement('div');
        card.className = 'card';

        const h = document.createElement('h3'); h.textContent = p.title; card.appendChild(h);
        const desc = document.createElement('p'); desc.textContent = p.desc || '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç:'; card.appendChild(desc);

        const row = document.createElement('div'); row.className = 'row';
        p.options.forEach(opt=>{
          const b = document.createElement('button');
          b.className = 'optbtn';
          b.textContent = opt;
          b.onclick = ()=>{
            state.plan = p.title; state.option = opt;
            renderStep3(); setStep(3);
          };
          row.appendChild(b);
        });
        card.appendChild(row);

        plansWrap.appendChild(card);
      });
    }

    function renderStep3(){
      // –ù–ò–ß–ï–ì–û –ù–ï –°–ë–†–ê–°–´–í–ê–ï–ú! –§–∞–π–ª –∏ —Ñ–∞–º–∏–ª–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏
      updateSummary();

      // UI –¥–ª—è —Ñ–∞–π–ª–∞/—Ñ–∞–º–∏–ª–∏–∏
      if(state.file){ fileInfo.textContent = `–∑–∞–≥—Ä—É–∂–µ–Ω: ${state.file.name || '—Ñ–∞–π–ª'}`; lastnameBtn.style.display='inline-block'; }
      else { fileInfo.textContent = '—Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'; lastnameBtn.style.display='none'; }

      updateSendState();
    }

    // ==== File handling ====
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files?.[0];
      if(!f){
        fileInfo.textContent='—Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'; state.file=null; lastnameBtn.style.display='none'; updateSendState(); return;
      }
      // Telegram Bot API –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–æ 50 –ú–ë. –î–µ—Ä–∂–∏–º –∑–∞–ø–∞—Å.
      const MAX_MB = 48;
      if(f.size > MAX_MB*1024*1024){
        fileInfo.textContent=`—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª (> ${MAX_MB}MB)`;
        toastMsg(`–§–∞–π–ª > ${MAX_MB}MB`);
        fileInput.value='';
        state.file=null; lastnameBtn.style.display='none'; updateSendState(); return;
      }
      fileInfo.textContent = `–∑–∞–≥—Ä—É–∂–µ–Ω: ${f.name || '—Ñ–∞–π–ª'}`;
      state.file = f;
      lastnameBtn.style.display='inline-block';
      updateSendState();
    });

    // ==== –í–≤–æ–¥ —Ñ–∞–º–∏–ª–∏–∏ ====
    lastnameBtn.addEventListener('click', ()=>{
      const val = (window.prompt('–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é —É—á–µ–Ω–∏–∫–∞(—Ü—ã):', state.lastname || '') || '').trim();
      if(!val){ toastMsg('–§–∞–º–∏–ª–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞'); updateSendState(); return; }
      state.lastname = val;
      toastMsg('–§–∞–º–∏–ª–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞');
      updateSummary();
      updateSendState();
    });

    // ==== Telegram API ====
    async function sendDocument(file, captionHtml){
      const url = `https://api.telegram.org/bot${ADMIN_BOT_TOKEN}/sendDocument`;
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
      const jobs = ADMIN_IDS.map(async (CHAT_ID)=>{
        const fd = new FormData();
        fd.append('chat_id', CHAT_ID);
        fd.append('caption', captionHtml);
        fd.append('parse_mode', 'HTML'); // —á—Ç–æ–±—ã –∫–ª–∏–∫–∞–ª—Å—è tg://user?id=...
        fd.append('document', file, file.name || 'check.jpg');
        const res = await fetch(url,{ method:'POST', body:fd });
        // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç Telegram
        let details = '';
        try{
          const js = await res.clone().json();
          if(!res.ok) details = js?.description || '';
        }catch(_){}
        if(!res.ok) throw new Error(details || 'sendDocument failed');
        return res.json();
      });
      // –•–æ—Ç–∏–º, —á—Ç–æ–±—ã –ø–∞–¥–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –Ω–µ –ª–æ–º–∞–ª–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ: —Å–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      const results = await Promise.allSettled(jobs);
      const failures = results.filter(r=>r.status==='rejected');
      if (failures.length === ADMIN_IDS.length){
        // —É–ø–∞–ª–æ –≤–µ–∑–¥–µ ‚Äî –±—Ä–æ—Å–∞–µ–º –æ–±—â—É—é –æ—à–∏–±–∫—É (–ø–µ—Ä–≤—É—é –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—é)
        throw new Error(failures[0].reason?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É');
      }
      return results;
    }

    // ==== Confirm ====
    sendBtn.addEventListener('click', async ()=>{
      if(!state.category || !state.plan || !state.option){ toastMsg('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç'); return; }

      // –ñ–Å–°–¢–ö–û–ï –£–°–õ–û–í–ò–ï: –±–µ–∑ —á–µ–∫–∞ –∏ —Ñ–∞–º–∏–ª–∏–∏ ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞
      if(!state.file){ toastMsg('–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —á–µ–∫/—Ñ–∞–π–ª'); return; }
      if(!state.lastname || !state.lastname.trim()){ toastMsg('–£–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é —É—á–µ–Ω–∏–∫–∞(—Ü—ã)'); return; }

      const whoBase = me?.username ? '@'+me.username : (me?.id ? 'id:'+me.id : '–≥–æ—Å—Ç—å');
      const fullName = [me?.first_name, me?.last_name].filter(Boolean).join(' ');
      const mention = me?.id ? `<a href="tg://user?id=${me.id}">${whoBase}</a>` : whoBase;

      const captionHtml =
        `üí≥ <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</b>\n`+
        `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${mention}${fullName ? ' ('+fullName+')' : ''}\n`+
        (me?.id ? `üÜî ID: <code>${me.id}</code>\n` : ``)+
        `üßë‚Äçüéì –§–∞–º–∏–ª–∏—è: <b>${escapeHtml(state.lastname)}</b>\n`+
        `üìö –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>${escapeHtml(state.category || '')}</b>\n`+
        `üßæ –ê–±–æ–Ω–µ–º–µ–Ω—Ç: <b>${escapeHtml(state.plan || '')}</b>\n`+
        `üíº –í–∞—Ä–∏–∞–Ω—Ç: <b>${escapeHtml(state.option || '')}</b>\n`+
        `üìé –ß–µ–∫: –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç`;

      sendBtn.disabled = true; const txt = sendBtn.textContent; sendBtn.textContent='–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶';

      try{
        await sendDocument(state.file, captionHtml); // –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –∏ –¥–æ–ø—É—Å–∫–∞–µ—Ç –∫—Ä—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã
        tg?.HapticFeedback?.impactOccurred?.('soft');
        safeAlert('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –°–ø–∞—Å–∏–±–æ!');
        toastMsg('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚úÖ');
        // tg.close();
      }catch(e){
        console.error(e);
        safeAlert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å. ' + (e?.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'));
        toastMsg('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ‚ùå');
      }finally{
        sendBtn.textContent=txt; updateSendState();
      }
    });

    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ==== Init ====
    function init(){ renderStep1(); setStep(1); updateSummary(); }
    init();
  </script>
</body>
</html>

