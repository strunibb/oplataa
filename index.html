<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      /* Telegram theme fallbacks (–±—É–¥—É—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∏–∑ tg.themeParams) */
      --tg-bg: #0b1020;
      --tg-text: #eef2ff;
      --tg-hint: rgba(238,242,255,.72);
      --tg-accent: #5b7cfa;
      --tg-accent-text: #0b1020;

      /* Brand / UI */
      --g1: #6a11cb;
      --g2: #2575fc;

      --surface: rgba(255,255,255,.08);
      --surface2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.22);

      --shadow1: 0 10px 28px rgba(0,0,0,.35);
      --shadow2: 0 18px 50px rgba(0,0,0,.40);

      --r12: 12px;
      --r16: 16px;
      --r20: 20px;

      --t: .22s cubic-bezier(.2,.8,.2,1);

      --container: 980px;
      --pad: 16px;
    }

    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color: var(--tg-text);
      min-height: 100vh;
      min-height: 100dvh;
      padding:
        calc(var(--pad) + env(safe-area-inset-top))
        calc(var(--pad) + env(safe-area-inset-right))
        calc(var(--pad) + env(safe-area-inset-bottom))
        calc(var(--pad) + env(safe-area-inset-left));
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(37,117,252,.45), transparent 60%),
        radial-gradient(1000px 700px at 110% 0%, rgba(106,17,203,.50), transparent 60%),
        linear-gradient(135deg, var(--g1), var(--g2));
      text-align:center;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Layout */
    .wrap{
      max-width: var(--container);
      margin: 0 auto;
      display: grid;
      gap: 12px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      padding: 14px 14px 10px;
      border-radius: var(--r20);
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      text-align:left;
    }

    .titlebox{ display:grid; gap:6px; }
    h1{
      margin:0;
      font-size: clamp(20px, 2.8vw, 28px);
      font-weight: 900;
      letter-spacing: .2px;
      line-height: 1.1;
      text-shadow: 0 10px 26px rgba(0,0,0,.22);
    }
    .sub{
      margin:0;
      font-size: clamp(12px, 1.6vw, 14px);
      color: var(--tg-hint);
      line-height: 1.35;
    }

    /* Stepper */
    .stepper{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      margin: 8px auto 0;
      user-select:none;
    }
    .step{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .dot{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      font-weight: 900;
      font-size: 13px;
      color: rgba(255,255,255,.92);
      background: rgba(255,255,255,.12);
      border: 1px solid var(--stroke2);
      box-shadow: 0 8px 20px rgba(0,0,0,.22);
      transition: transform var(--t), background var(--t), border-color var(--t), color var(--t);
    }
    .dot.active{
      background: linear-gradient(135deg, rgba(255,255,255,.24), rgba(255,255,255,.12));
      border-color: rgba(255,255,255,.40);
      transform: translateY(-1px);
    }
    .dot.done{
      background: linear-gradient(135deg, rgba(89,255,166,.95), rgba(41,209,124,.95));
      border-color: transparent;
      color: #103225;
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
    }
    .bar{
      width: 56px;
      height: 2px;
      border-radius: 99px;
      background: rgba(255,255,255,.22);
      border: 1px solid rgba(255,255,255,.08);
    }

    /* Panels */
    .panel{
      text-align:left;
      padding: 14px;
      border-radius: var(--r20);
      border: 1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: var(--shadow1);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .panelhead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .panel h3{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .muted{ color: var(--tg-hint); font-size: 13px; margin:0; }

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      margin-top: 6px;
    }

    /* Buttons */
    .btn{
      appearance:none;
      -webkit-tap-highlight-color: transparent;
      border: 1px solid var(--stroke2);
      background: linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
      color: rgba(255,255,255,.95);
      border-radius: 16px;
      padding: 12px 12px;
      font-weight: 850;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      transition: transform var(--t), box-shadow var(--t), background var(--t), border-color var(--t), opacity var(--t);
    }
    .btn:hover{ transform: translateY(-2px); box-shadow: var(--shadow2); background: linear-gradient(135deg, rgba(255,255,255,.22), rgba(255,255,255,.10)); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn:focus-visible{
      outline: 3px solid rgba(255,255,255,.22);
      outline-offset: 2px;
    }

    .btn.primary{
      border: none;
      background: linear-gradient(135deg, var(--tg-accent), rgba(255,255,255,.14));
      color: var(--tg-accent-text);
      text-shadow: none;
    }
    .btn.primary:hover{ background: linear-gradient(135deg, rgba(255,255,255,.14), var(--tg-accent)); }

    .btn.ghost{
      background: rgba(255,255,255,.08);
      border: 1px solid var(--stroke);
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
    }

    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      filter: grayscale(.15);
    }

    /* Category buttons take full card width */
    .catbtn{ grid-column: span 6; text-align:left; }
    .catbtn .small{ display:block; margin-top:4px; font-size:12px; color: var(--tg-hint); font-weight:700; }

    /* Plan cards */
    .card{
      grid-column: span 6;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      transition: transform var(--t), box-shadow var(--t);
    }
    .card:hover{ transform: translateY(-2px); box-shadow: var(--shadow2); }
    .card h4{
      margin:0 0 8px;
      font-size: 16px;
      font-weight: 900;
      letter-spacing:.2px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,.14);
    }
    .card p{
      margin: 0 0 10px;
      color: var(--tg-hint);
      font-size: 13px;
      line-height: 1.35;
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
    }
    .optbtn{ flex: 1 1 180px; text-align:left; }

    /* Step3 summary */
    .summary{
      font-size: 14px;
      line-height: 1.55;
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      margin-top: 6px;
    }

    /* file + name */
    .filebox{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      text-align:center;
    }
    .file-input{ display:none; }
    .file-label{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      border: 1px solid var(--stroke2);
      background: linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
      font-weight: 900;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      transition: transform var(--t), box-shadow var(--t), background var(--t);
      -webkit-tap-highlight-color: transparent;
    }
    .file-label:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); background: linear-gradient(135deg, rgba(255,255,255,.22), rgba(255,255,255,.10)); }
    .file-info{ font-size: 12px; color: var(--tg-hint); max-width: 100%; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--tg-hint);
    }

    /* Back row */
    .backwrap{
      display:flex;
      justify-content:center;
      margin-top: 12px;
      gap: 10px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(14px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      background: rgba(0,0,0,.66);
      color:#fff;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: 0 14px 34px rgba(0,0,0,.45);
      opacity:0;
      pointer-events:none;
      transition: opacity .22s ease, transform .22s ease;
      max-width: min(520px, calc(100vw - 24px));
      text-align:center;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-2px); }

    /* Responsive */
    @media (max-width: 900px){
      .catbtn{ grid-column: span 12; }
      .card{ grid-column: span 12; }
    }
    @media (max-width: 520px){
      header{ padding: 12px; }
      .bar{ width: 34px; }
      .optbtn{ flex: 1 1 100%; }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; scroll-behavior: auto !important; }
      .toast{ transition: opacity .01s linear !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="titlebox">
        <h1>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</h1>
        <p class="sub">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –∞–±–æ–Ω–µ–º–µ–Ω—Ç ‚Üí –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —á–µ–∫ ‚Üí —É–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é ‚Üí –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</p>
      </div>
    </header>

    <div class="stepper" id="stepper" aria-label="–®–∞–≥–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è">
      <div class="step"><div class="dot active" data-step="1">1</div></div>
      <div class="bar" aria-hidden="true"></div>
      <div class="step"><div class="dot" data-step="2">2</div></div>
      <div class="bar" aria-hidden="true"></div>
      <div class="step"><div class="dot" data-step="3">3</div></div>
    </div>

    <!-- –®–ê–ì 1: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div id="step1" class="panel">
      <div class="panelhead">
        <div>
          <h3>–®–∞–≥ 1 ‚Äî –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
          <p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ–±—É—á–µ–Ω–∏—è</p>
        </div>
      </div>
      <div class="grid" id="categories"></div>
    </div>

    <!-- –®–ê–ì 2: –ê–±–æ–Ω–µ–º–µ–Ω—Ç -->
    <div id="step2" class="panel" style="display:none">
      <div class="panelhead">
        <div>
          <h3 id="chosenCategory" style="margin:0 0 4px"></h3>
          <p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç –∏ –≤–∞—Ä–∏–∞–Ω—Ç</p>
        </div>
      </div>

      <div id="plans" class="grid"></div>

      <div class="backwrap">
        <button class="btn ghost" type="button" onclick="goStep(1)">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
    </div>

    <!-- –®–ê–ì 3: –ß–µ–∫ + –æ—Ç–ø—Ä–∞–≤–∫–∞ -->
    <div id="step3" class="panel" style="display:none">
      <div class="panelhead">
        <div>
          <h3>–®–∞–≥ 3 ‚Äî –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
          <p class="muted">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —á–µ–∫ –∏ —É–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é</p>
        </div>
      </div>

      <div id="summary" class="summary"></div>

      <div class="filebox">
        <input type="file" id="receipt" class="file-input" accept="image/*,.pdf,.heic,.heif,.png,.jpg,.jpeg,.webp">
        <label class="file-label" for="receipt">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —á–µ–∫</label>
        <span id="fileInfo" class="file-info">—Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
        <button id="lastnameBtn" class="btn ghost" type="button" style="display:none">üìù –§–∞–º–∏–ª–∏—è —É—á–µ–Ω–∏–∫–∞(—Ü—ã)</button>
      </div>

      <div id="hint" class="hint">–ß—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —á–µ–∫ –∏ —É–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é —É—á–µ–Ω–∏–∫–∞(—Ü—ã).</div>

      <button id="sendBtn" class="btn primary" style="width:100%;margin-top:12px" disabled>‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</button>

      <div class="backwrap">
        <button class="btn ghost" type="button" onclick="goStep(2)">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <script>
    // ==== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ====
    const ADMIN_BOT_TOKEN = '7598736914:AAF1EK5D_g0gjflP7bKdtSgz8OyNz1q59PU';
    const ADMIN_IDS = ['725158536', '5056461242']; // + @Yuliya2821

    // ==== Telegram WebApp –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–µ–¥—ã ====
    const tg = window.Telegram?.WebApp;
    tg?.expand?.(); tg?.ready?.();

    const IS_TG_WEBAPP = !!(tg && (tg.initData || tg.initDataUnsafe?.user?.id));

    if (!IS_TG_WEBAPP) {
      document.body.innerHTML = `
        <div style="min-height:100vh;display:grid;place-items:center;padding:24px;color:#fff;background:linear-gradient(135deg,#6a11cb,#2575fc);text-align:center">
          <div style="max-width:560px">
            <h2 style="margin:0 0 8px">‚ùå –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ Telegram</h2>
            <p style="opacity:.9">
              –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –±–æ—Ç <b>@strunib_bot</b> –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É
              <b>¬´–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã¬ª</b>. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.
            </p>
          </div>
        </div>`;
      throw new Error('Not a Telegram WebApp context');
    }

    // ==== –ü–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥ —Ç–µ–º—É Telegram ====
    function applyTelegramTheme(){
      try{
        const tp = tg?.themeParams || {};
        const root = document.documentElement;

        // Telegram –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Ü–≤–µ—Ç–∞ –∫–∞–∫ hex (#rrggbb)
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º button_color/text_color/hint_color/bg_color, –µ—Å–ª–∏ –µ—Å—Ç—å.
        const bg = tp.bg_color || null;
        const text = tp.text_color || null;
        const hint = tp.hint_color || null;
        const btn = tp.button_color || null;
        const btnText = tp.button_text_color || null;

        if (bg) root.style.setProperty('--tg-bg', bg);
        if (text) root.style.setProperty('--tg-text', text);
        if (hint) root.style.setProperty('--tg-hint', hint);
        if (btn) root.style.setProperty('--tg-accent', btn);
        if (btnText) root.style.setProperty('--tg-accent-text', btnText);

        // –ï—Å–ª–∏ —Ñ–æ–Ω —É Telegram —Å–≤–µ—Ç–ª—ã–π ‚Äî —Å–ª–µ–≥–∫–∞ —Å–º—è–≥—á–∏–º –≥—Ä–∞–¥–∏–µ–Ω—Ç
        // (–ø—Ä–æ—Å—Ç–æ –ø–æ —è—Ä–∫–æ—Å—Ç–∏ hex –≥—Ä—É–±–æ).
        if (bg && isLight(bg)) {
          root.style.setProperty('--surface', 'rgba(0,0,0,.06)');
          root.style.setProperty('--surface2', 'rgba(0,0,0,.08)');
          root.style.setProperty('--stroke', 'rgba(0,0,0,.10)');
          root.style.setProperty('--stroke2', 'rgba(0,0,0,.14)');
        }
      }catch(_){}
    }

    function isLight(hex){
      // hex: #rrggbb
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      if(!m) return false;
      const r = parseInt(m[1],16), g = parseInt(m[2],16), b = parseInt(m[3],16);
      // perceived luminance
      const L = (0.2126*r + 0.7152*g + 0.0722*b)/255;
      return L > 0.65;
    }

    applyTelegramTheme();
    tg?.onEvent?.('themeChanged', applyTelegramTheme);

    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ Telegram initData
    const me = tg?.initDataUnsafe?.user || null;

    // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∞–ª–µ—Ä—Ç
    function safeAlert(msg){
      if (tg?.showAlert) {
        try { tg.showAlert(msg); }
        catch(_){ alert(msg); }
      } else {
        alert(msg);
      }
    }

    // ==== –î–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è/–∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã) ====
    const DATA = {
      "üé∏ –ì–∏—Ç–∞—Ä–∞ / –≠–ª–µ–∫—Ç—Ä–æ–≥–∏—Ç–∞—Ä–∞": [
        { title: "üß© –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (1 –º–µ—Å—è—Ü)", options: ["4 —É—Ä–æ–∫–∞", "8 —É—Ä–æ–∫–æ–≤"] },
        { title: "üß© –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (2 –º–µ—Å—è—Ü–∞)", options: ["8 —É—Ä–æ–∫–æ–≤", "16 —É—Ä–æ–∫–æ–≤"] },
        { title: "üéØ –†–∞–∑–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ (40 –º–∏–Ω)", options: ["1 —É—Ä–æ–∫ (40 –º–∏–Ω)"] },
      ],
      "üéπ –§–æ—Ä—Ç–µ–ø–∏–∞–Ω–æ / –ü–∏–∞–Ω–∏–Ω–æ": [
        { title: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (1 –º–µ—Å—è—Ü)", options: ["4 –∑–∞–Ω—è—Ç–∏—è (40 –º–∏–Ω)", "8 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)"] },
        { title: "üë• –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (2 –º–µ—Å—è—Ü–∞)", options: ["8 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)", "16 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)"] }
      ],
      "üéµ –£–∫—É–ª–µ–ª–µ": [
        { title: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (1 –º–µ—Å—è—Ü)", options: ["4 –∑–∞–Ω—è—Ç–∏—è (40 –º–∏–Ω)", "8 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)"] },
        { title: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (2 –º–µ—Å—è—Ü–∞)", options: ["8 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)", "16 –∑–∞–Ω—è—Ç–∏–π (40 –º–∏–Ω)"] }
      ],
      "üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫": [
        {
          title: "üÜï –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (1 –º–µ—Å—è—Ü)",
          desc: "–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ–Ω–ª–∞–π–Ω-—É—Ä–æ–∫–∏ —Å —É–ø–æ—Ä–æ–º –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä, –ª–µ–∫—Å–∏–∫—É –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏ –∏ –∂–∏–≤–æ–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ.",
          options: [
            "4 —É—Ä–æ–∫–∞ (1 —á–∞—Å) ‚Äî 2 990 ‚ÇΩ (‚âà 748 ‚ÇΩ/—É—Ä–æ–∫)",
            "8 —É—Ä–æ–∫–æ–≤ (1 —á–∞—Å) ‚Äî 5 790 ‚ÇΩ (‚âà 724 ‚ÇΩ/—É—Ä–æ–∫)"
          ]
        },
        {
          title: "üìà –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (2 –º–µ—Å—è—Ü–∞)",
          desc: "–§–æ—Ä–º–∞—Ç –Ω–∞ –ø–æ–¥–æ–ª—å—à–µ: —Ç–µ –∂–µ —É—Å–ª–æ–≤–∏—è, –Ω–æ –≤—ã–≥–æ–¥–Ω–µ–µ –ø–æ —Ü–µ–Ω–µ –∑–∞ –∑–∞–Ω—è—Ç–∏–µ.",
          options: [
            "8 —É—Ä–æ–∫–æ–≤ (1 —á–∞—Å) ‚Äî 5 790 ‚ÇΩ (‚âà 724 ‚ÇΩ/—É—Ä–æ–∫)",
            "16 —É—Ä–æ–∫–æ–≤ (1 —á–∞—Å) ‚Äî 10 990 ‚ÇΩ (‚âà 687 ‚ÇΩ/—É—Ä–æ–∫)"
          ]
        },
        {
          title: "üéØ –†–∞–∑–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ (1 —á–∞—Å)",
          desc: "–¢–æ—á–µ—á–Ω—ã–π —Ä–∞–∑–±–æ—Ä –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏, –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è –∏–ª–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–π —Ç–µ–º—ã.",
          options: [
            "1 —É—Ä–æ–∫ ‚Äî 850 ‚ÇΩ"
          ]
        }
      ],
      "üë©‚Äçüè´ –ù–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ —Å –ù–∏–∫–∏—Ç–æ–π ": [
        { title: "–ù–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ (1 –º–µ—Å—è—Ü)", options: ["2 790 ‚ÇΩ –∑–∞ –º–µ—Å—è—Ü"] },
        { title: "–ù–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ (2 –º–µ—Å—è—Ü–∞)", options: ["4 990 ‚ÇΩ –∑–∞ 2 –º–µ—Å—è—Ü–∞"] }
      ],
      "üìò –ö—É—Ä—Å ¬´–ë–∞–∑–æ–≤—ã–π –º–∏–Ω–∏–º—É–º¬ª": [
        {
          title: "–û–ø—Ü–∏–∏ –æ–ø–ª–∞—Ç—ã",
          options: [
            "–í—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å—Ä–∞–∑—É (8 –º–æ–¥—É–ª–µ–π) ‚Äî 7 490 ‚ÇΩ",
            "2 –º–æ–¥—É–ª—è –≤ –º–µ—Å—è—Ü ‚Äî 1 872 ‚ÇΩ",
            "4 –º–æ–¥—É–ª—è –≤ –º–µ—Å—è—Ü ‚Äî 3 745 ‚ÇΩ"
          ]
        }
      ]
    };

    // ==== –°–æ—Å—Ç–æ—è–Ω–∏–µ ====
    const state = { category:null, plan:null, option:null, file:null, lastname:null };

    // ==== DOM ====
    const stepDots = [...document.querySelectorAll('.dot')];
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');

    const categories = document.getElementById('categories');
    const plansWrap = document.getElementById('plans');
    const chosenCategory = document.getElementById('chosenCategory');

    const fileInput = document.getElementById('receipt');
    const fileInfo = document.getElementById('fileInfo');
    const lastnameBtn = document.getElementById('lastnameBtn');
    const sendBtn = document.getElementById('sendBtn');

    const toast = document.getElementById('toast');
    const hint = document.getElementById('hint');
    const summaryEl = document.getElementById('summary');

    // ==== UI helpers ====
    function setStep(n){
      stepDots.forEach((d,i)=>{
        d.classList.remove('active','done');
        if(i+1 < n) d.classList.add('done');
        else if(i+1 === n) d.classList.add('active');
      });
      step1.style.display = n===1?'block':'none';
      step2.style.display = n===2?'block':'none';
      step3.style.display = n===3?'block':'none';
    }
    function goStep(n){ setStep(n); }

    function toastMsg(msg,ms=2200){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), ms);
    }

    function updateSendState(){
      const hasFile = !!state.file;
      const hasLastname = !!(state.lastname && state.lastname.trim());
      const ready = hasFile && hasLastname;
      sendBtn.disabled = !ready;
      hint.textContent = ready ? '–í—Å–µ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ.' : '–ß—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —á–µ–∫ –∏ —É–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é —É—á–µ–Ω–∏–∫–∞(—Ü—ã).';
    }

    function updateSummary(){
      const whoBase = me?.username ? '@'+me.username : (me?.id ? 'id:'+me.id : '–≥–æ—Å—Ç—å');
      const fullName = [me?.first_name, me?.last_name].filter(Boolean).join(' ');
      summaryEl.innerHTML = `<div>
          üë§ <b>${escapeHtml(whoBase)}${fullName ? ' ('+escapeHtml(fullName)+')' : ''}</b> ${state.lastname ? `(—Ñ–∞–º–∏–ª–∏—è: <b>${escapeHtml(state.lastname)}</b>)` : ''}<br>
          üìö <b>${escapeHtml(state.category || '‚Äî')}</b><br>
          üßæ <b>${escapeHtml(state.plan || '‚Äî')}</b><br>
          üíº <b>${escapeHtml(state.option || '‚Äî')}</b>
        </div>`;
    }

    // ==== –†–µ–Ω–¥–µ—Ä —à–∞–≥–æ–≤ ====
    function renderStep1(){
      categories.innerHTML = '';
      Object.keys(DATA).forEach(cat=>{
        const btn = document.createElement('button');
        btn.className = 'btn catbtn';
        btn.innerHTML = `${escapeHtml(cat)}<span class="small">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</span>`;
        btn.onclick = ()=>{
          state.category = cat; state.plan=null; state.option=null;
          renderStep2(); setStep(2);
        };
        categories.appendChild(btn);
      });
    }

    function renderStep2(){
      chosenCategory.textContent = `–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${state.category}`;
      plansWrap.innerHTML = '';
      const plans = DATA[state.category] || [];

      plans.forEach((p)=>{
        const card = document.createElement('div');
        card.className = 'card';

        const h = document.createElement('h4'); h.textContent = p.title; card.appendChild(h);

        const desc = document.createElement('p');
        desc.textContent = p.desc || '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç:';
        card.appendChild(desc);

        const row = document.createElement('div'); row.className = 'row';
        (p.options || []).forEach(opt=>{
          const b = document.createElement('button');
          b.className = 'btn optbtn';
          b.textContent = opt;
          b.onclick = ()=>{
            state.plan = p.title; state.option = opt;
            renderStep3(); setStep(3);
          };
          row.appendChild(b);
        });
        card.appendChild(row);

        plansWrap.appendChild(card);
      });
    }

    function renderStep3(){
      updateSummary();

      if(state.file){
        fileInfo.textContent = `–∑–∞–≥—Ä—É–∂–µ–Ω: ${state.file.name || '—Ñ–∞–π–ª'}`;
        lastnameBtn.style.display='inline-flex';
      }else{
        fileInfo.textContent = '—Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
        lastnameBtn.style.display='none';
      }

      updateSendState();
    }

    // ==== File handling ====
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files?.[0];
      if(!f){
        fileInfo.textContent='—Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
        state.file=null;
        lastnameBtn.style.display='none';
        updateSendState();
        return;
      }
      const MAX_MB = 48;
      if(f.size > MAX_MB*1024*1024){
        fileInfo.textContent=`—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª (> ${MAX_MB}MB)`;
        toastMsg(`–§–∞–π–ª > ${MAX_MB}MB`);
        fileInput.value='';
        state.file=null;
        lastnameBtn.style.display='none';
        updateSendState();
        return;
      }
      fileInfo.textContent = `–∑–∞–≥—Ä—É–∂–µ–Ω: ${f.name || '—Ñ–∞–π–ª'}`;
      state.file = f;
      lastnameBtn.style.display='inline-flex';
      updateSendState();
    });

    // ==== –í–≤–æ–¥ —Ñ–∞–º–∏–ª–∏–∏ ====
    lastnameBtn.addEventListener('click', ()=>{
      const val = (window.prompt('–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é —É—á–µ–Ω–∏–∫–∞(—Ü—ã):', state.lastname || '') || '').trim();
      if(!val){
        toastMsg('–§–∞–º–∏–ª–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞');
        updateSendState();
        return;
      }
      state.lastname = val;
      toastMsg('–§–∞–º–∏–ª–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞');
      updateSummary();
      updateSendState();
    });

    // ==== Telegram API ====
    async function sendDocument(file, captionHtml){
      const url = `https://api.telegram.org/bot${ADMIN_BOT_TOKEN}/sendDocument`;

      const jobs = ADMIN_IDS.map(async (CHAT_ID)=>{
        const fd = new FormData();
        fd.append('chat_id', CHAT_ID);
        fd.append('caption', captionHtml);
        fd.append('parse_mode', 'HTML');
        fd.append('document', file, file.name || 'check.jpg');

        const res = await fetch(url,{ method:'POST', body:fd });

        let details = '';
        try{
          const js = await res.clone().json();
          if(!res.ok) details = js?.description || '';
        }catch(_){}

        if(!res.ok) throw new Error(details || 'sendDocument failed');
        return res.json();
      });

      const results = await Promise.allSettled(jobs);
      const failures = results.filter(r=>r.status==='rejected');
      if (failures.length === ADMIN_IDS.length){
        throw new Error(failures[0].reason?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É');
      }
      return results;
    }

    // ==== Confirm ====
    sendBtn.addEventListener('click', async ()=>{
      if(!state.category || !state.plan || !state.option){ toastMsg('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç'); return; }
      if(!state.file){ toastMsg('–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —á–µ–∫/—Ñ–∞–π–ª'); return; }
      if(!state.lastname || !state.lastname.trim()){ toastMsg('–£–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é —É—á–µ–Ω–∏–∫–∞(—Ü—ã)'); return; }

      const whoBase = me?.username ? '@'+me.username : (me?.id ? 'id:'+me.id : '–≥–æ—Å—Ç—å');
      const fullName = [me?.first_name, me?.last_name].filter(Boolean).join(' ');
      const mention = me?.id ? `<a href="tg://user?id=${me.id}">${escapeHtml(whoBase)}</a>` : escapeHtml(whoBase);

      const captionHtml =
        `üí≥ <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</b>\n`+
        `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${mention}${fullName ? ' ('+escapeHtml(fullName)+')' : ''}\n`+
        (me?.id ? `üÜî ID: <code>${me.id}</code>\n` : ``)+
        `üßë‚Äçüéì –§–∞–º–∏–ª–∏—è: <b>${escapeHtml(state.lastname)}</b>\n`+
        `üìö –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>${escapeHtml(state.category || '')}</b>\n`+
        `üßæ –ê–±–æ–Ω–µ–º–µ–Ω—Ç: <b>${escapeHtml(state.plan || '')}</b>\n`+
        `üíº –í–∞—Ä–∏–∞–Ω—Ç: <b>${escapeHtml(state.option || '')}</b>\n`+
        `üìé –ß–µ–∫: –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç`;

      sendBtn.disabled = true;
      const txt = sendBtn.textContent;
      sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶';

      try{
        await sendDocument(state.file, captionHtml);
        tg?.HapticFeedback?.impactOccurred?.('soft');
        safeAlert('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –°–ø–∞—Å–∏–±–æ!');
        toastMsg('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚úÖ');
        // tg.close();
      }catch(e){
        console.error(e);
        safeAlert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å. ' + (e?.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'));
        toastMsg('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ‚ùå');
      }finally{
        sendBtn.textContent = txt;
        updateSendState();
      }
    });

    function escapeHtml(s=''){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ==== Init ====
    function init(){
      renderStep1();
      setStep(1);
      updateSummary();
    }
    init();
  </script>
</body>
</html>
